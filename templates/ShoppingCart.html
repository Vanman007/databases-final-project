{% extends "base.html" %}
{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container is-fluid">

    <section class="section">
        <div class="container">
            {% if haspurchases%}
            <nav class="level">
                    <div class="level-item has-text-centered">
                        <a href="/"><button class="link is-info">Buy more</button></a>
                    </div>
                    <div class="level-item has-text-centered">
                        <a href="/checkout"><button class="link is-info">Checkout</button></a>
                    </div>
                  </nav>

            <h2 class="title has-text-centered">Your Shopping Chart</h2>
            <table class="table" width="100%">
                    <thead>
                      <tr>
                        <th width="10%"><abbr title="Image">IMG</abbr></th>
                        <th width="10%"><abbr title="Name">Name</abbr></th>
                        <th width="35%"><abbr title="Description"> Description</abbr></th>
                        <th width="15%"><abbr title="Amount">Quantity</abbr></th>
                        <th width="15%"><abbr title="Price">Price</abbr></th>
                        <th width="15%"><abbr title="Delete">Remove</abbr></th>
                      </tr>
                    </thead>
                    <tbody>
                        {%for product in cartProduct%}
                      <tr id="DeleteDivProduct{{ product.iProductId }}">
                        <td>/somdest/{{product.iProductId}}.img</td>
                        <td>{{product.cName}}</td>
                        <td>{{product.cDescription}}</td>
                        <td id="quantity{{ product.iProductId }}">x</td>
                        <td id="price{{ product.iProductId }}">{{product.fUnitPrice|dkk}}</td>
                        <td><button class="link" class="button" id="DeleteProduct{{ product.iProductId }}" value="{{ product.iProductId }}">-</button>
                        </td>
                      </tr>

                      {%endfor%}
                    </tbody>
                </table>
            {% else %}
                <h2 class="title has-text-centered">You got no items in ur chart. get back out there and shop away!</h2>
            {% endif %}
        </div>
    </section>
</div>

                    
<script>
passUniqeProducts = '{{uniqeProducts|tojson}}';
var uniqeProducts = JSON.parse(passUniqeProducts);

$(document).ready(function (){
    $.each(uniqeProducts, function(k, v) {
    var $quantityElement = $("#quantity"+k);
    var text = $quantityElement.text();
    $quantityElement.text(text.replace(text, v+""));
});
});

$(function() {
    $('[id^=DeleteProduct]').click(function() {
        productId=$(this).val()
        $.ajax({
            url: '/DeleteFromCart',
            contentType: 'application/json',
            data: JSON.stringify(productId),
            dataType : 'text',
            type: 'POST',
            success: function(response) {
                var $quantityElement = $("#quantity"+productId)
                var oldText = $quantityElement.text();
                var textVal = parseInt($quantityElement.text());
                if (textVal != 1){
                    textVal=textVal-1
                    $quantityElement.text(oldText.replace(oldText, textVal+""))
                }else{
                    $("#DeleteDivProduct"+productId).remove()
                }

            },
            error: function(error) {
                alert("Oh no somthing went wrong! ur product was not deleted");
            }
        });
    });
});
</script>

{% endblock %}